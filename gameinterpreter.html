<!DOCTYPE html>
<html>
<body>
<style>
html {
    font-size: 14px;
}
label {
    background:#ccf;
    padding:3px 10px;
    margin:10px;
    border-radius: 10px;
}
button {
    width:100px;
    height:30px;
    margin:10px;
    background:#ccf;
    border-radius: 10px;
}
button:hover {
    background:#88f;
    color:#fff;
}
button.run {
    background:#f88;
}
button.run:hover {
    background:#f88;
    color:#000;
}
</style>
<h1>Game Interpreter</h1>
GitHub : <a href="https://github.com/g200kg/game-interpreter">https://github.com/g200kg/game-interpreter</a>
<hr/><br/>
Code:<br/>
<textarea id="code" style="width:800px;height:200px; overflow:scroll">
</textarea><br/>
<button id='run'>Run</button> <button id='stop'>Stop</button> <button id='new'>New</button> CurLine:<input id="line" style="width:50px" readonly/> <label><input id='trace' type="checkbox"/>Trace</label> Sample:<select id='sample'>
    <option>Sum1to10</option>
    <option>Hanoi</option>
    <option>Factorial</option>
    <option>Wave</option>
    <option>LoopTest</option>
</select><button id='load'>Load</button><br/>
<br/>
<hr/>
Output:<br/>
<textarea id="output" readonly tabindex="1" style="width:800px;height:200px; overflow:scroll">
</textarea>
<br/>
<button id="clear">Clear</button><br/>
<script src="coi-serviceworker.js"></script>
<script>

sample = [
'\
100#=== Sum 1 to 10 ==== \n\
110 S=0\n\
120 A=1,10\n\
130 ?=A "  "\n\
140 S=S+A\n\
150 @=A+1\n\
160 / "======"/\n\
170 "SUM:" ?=S /\n\
',
'\
1000#==== Hanoi ====\n\
1010 / "Tower of Hanoi" /\n\
1010 "Number of Disks ? " A=?\n\
1020 B=$1000 C=0\n\
1030 B(0)=A B(1)=$41 B(2)=$43 B(3)=$42\n\
1040 !=2000\n\
1050 #=-1\n\
2000#==== Sub ====\n\
2010 ;=B(C)=0 C=C-4 ]\n\
2060 C=C+4\n\
2020 B(C)=B(C-4)-1\n\
2030 B(C+1)=B(C-3)\n\
2040 B(C+2)=B(C-1)\n\
2050 B(C+3)=B(C-2)\n\
2060 !=2000\n\
2070 "Move Disk " ?=B(C) " from " $=B(C+1) " to " $=B(C+2) /\n\
2060 C=C+4\n\
2020 B(C)=B(C-4)-1\n\
2030 B(C+1)=B(C-1)\n\
2040 B(C+2)=B(C-2)\n\
2050 B(C+3)=B(C-3)\n\
2080 !=2000\n\
2020 C=C-4 ]\n\
',
'\
100#====Factorial====\n\
110 / "Calc Factorial" /\n\
120 "Number ? " A=?\n\
130 S=1\n\
140 !=1000\n\
150 ?=S\n\
160 #=-1\n\
1000 ;=A=0 ]\n\
1000 S=S*A\n\
1010 A=A-1\n\
1020 !=1000\n\
1030 ]\n\
',
'\
1000#====Wave====\n\
1010 X=1000\n\
1020 V=0\n\
1030 N=1,150\n\
1040 X=X+V\n\
1050 V=V-(X/10)\n\
1060 .=X/50+25 "*" /\n\
1070 @=N+1\n\
',
'\
100#====LoopTest====\n\
110 I=0,10\n\
120 ?=I\n\
130 J=0,10000\n\
140 K=0,1000\n\
150 @=K+1\n\
160 @=J+1\n\
170 @=I+1\n\
'
]
;

let worker = new Worker('gameworker.js');
let outStr = '';
let inputKey = 0;
let inputStr = '';
let wait = '';

let sab = new SharedArrayBuffer(10);
let sabStat = new Int16Array(sab);
const ISRUN = 0;        // sabStat[ISRUN]
const INPUTWAIT = 1;    // sabStat[INPUTWAIT]
const INPUTVALUE = 2;   // sabStat[INPUTVALUE]
const CURLINE = 3;      // sabStat[CURLINE]
const TRACE = 4;        // sabStat[TRACE]

worker.postMessage(['init', sab]);

function keyCode(ev) {
    switch(ev.key) {
    case 'Backspace': return 0x8;
    case 'Tab': return 0x9;
    case 'Enter': return 0xd;
    case 'Insert': return 0x12;
    case 'Escape': return 0x1b;
    case 'ArrowRight': return 0x1c;
    case 'ArrowLeft': return 0x1d;
    case 'ArrowUp': return 0x1e;
    case 'ArrowDown':return 0x1f;
    case 'Delete': return 0x7f;
    case 'Shift':
    case 'Alt':
    case 'Control': return 0;
    }
    if(ev.ctrlKey) {
        if(ev.key >= 'A' && ev.key <= 'Z') {
            return ev.key.charCodeAt(0) - 0x40;
        }
        if(ev.key >= 'a' && ev.key <= 'z') {
            return ev.key.charCodeAt(0) - 0x60;
        }
        return 0;
    }
    return ev.key.charCodeAt(0);
}
document.getElementById('output').addEventListener('keydown', (ev)=> {
    if(wait == '$') {
        inputKey = keyCode(ev);
        if(inputKey) {
            outStr += ev.key;
            document.getElementById("output").value = outStr;
            sabStat[INPUTVALUE] = inputKey;
            sabStat[INPUTWAIT] = 0;
        }
    }
    if(wait == '?') {
        if(ev.key >= '0' && ev.key <= '9') {
            inputStr += ev.key;
            document.getElementById("output").value = outStr + inputStr;
            return;
        }
        switch(ev.key) {
        case 'Backspace':
            if(inputStr.length > 0) {
                inputStr = inputStr.slice(0, -1);
                document.getElementById("output").value = outStr + inputStr;
            }
            break;
        case 'Enter':
            outStr += inputStr + '\n';
            document.getElementById("output").value = outStr;
            sabStat[INPUTVALUE] = inputStr | 0;
            sabStat[INPUTWAIT] = 0;
            break;
        }
    }
});
document.getElementById('run').addEventListener('click', () => {
    if(sabStat[ISRUN])
        return;
    worker.postMessage(['code', document.getElementById('code').value]);
    worker.postMessage(['run']);
    document.getElementById('run').classList.add("run");
});
document.getElementById('stop').addEventListener('click', () => {
    sabStat[ISRUN] = 0;
    sabStat[INPUTWAIT] = 0;
    sabStat[INPUTVALUE] = 0;
});
document.getElementById('new').addEventListener('click', () => {
    document.getElementById('code').value = '';
});
document.getElementById('load').addEventListener('click', () => {
    document.getElementById('code').value = sample[document.getElementById('sample').selectedIndex];
});
document.getElementById('clear').addEventListener('click', () => {
    document.getElementById('output').value = outStr = '';
});
document.getElementById('trace').addEventListener('change', () => {
    sabStat[TRACE] = document.getElementById('trace').checked ? 1 : 0;
});
worker.addEventListener('message', function (e) {
    switch(e.data[0]) {
    case 'error':
        outStr += `\n\nERROR ${e.data[1]} line:${e.data[2]}\n`;
        document.getElementById("output").value = outStr;
        break;
    case 'input':
        inputKey = 0;
        inputStr = '';
        wait = e.data[1];
        break;
    case 'output':
        outStr += e.data[1];
        document.getElementById("output").value = outStr;
        break;
    }
}, false);

onload = () => {
    document.getElementById('code').value = sample[0];
    setInterval(()=>{
        if(sab) {
            if(sabStat[ISRUN] == 0) {
                document.getElementById('run').classList.remove('run');
            }
            document.getElementById('line').value = sabStat[CURLINE];
        }
    },100);
}
</script>
</body>
</html>